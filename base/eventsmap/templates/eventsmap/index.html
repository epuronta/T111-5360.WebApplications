<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    
    <!-- viewport -->
    <!-- iOS stuff -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="white">
    
    <!-- Mobile IE allows us to activate ClearType technology for smoothing fonts for easy reading -->
    <meta http-equiv="cleartype" content="on">
    
    <!-- For mobile browsers that do not recognize the viewport tag -->
    <meta name="MobileOptimized" content="320" />
    
    <title>AaltoMobile > EventsMap</title>
    <link rel="stylesheet" href="{{ STATIC_URL }}css/style.css" type="text/css" />
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.1.0-rc.1/jquery.mobile-1.1.0-rc.1.min.css" />
    <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/jquery.mobile.simpledialog.css" />
    
    <script src="{{ STATIC_URL }}js/jquery-1.7.1.min.js"></script>
    <script src="http://code.jquery.com/mobile/1.1.0-rc.1/jquery.mobile-1.1.0-rc.1.min.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/jquery.mobile.simpledialog2.js"></script>

    <!--<script src="http://www.openlayers.org/api/OpenLayers.js"></script>-->
    <script src="http://openlayers.org/dev/OpenLayers.mobile.js"></script>

    <style type="text/css">

        .page {
            height: 100%;
        }

        .header {
            height: 5%;
        }
        .content {
            height: 100%;
            padding: 0;
        } 
        #basicmap  {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #basicmap img.olTileImage {
            max-width: 1000%;
        }

        .olControlAttribution {
            font-size: 70%;
            position: absolute;
            bottom: 0;
            right: 0;
        }

        .olControlZoom {
            position: absolute;
            left: 0;
            top: 0;
        }

        .olControlZoom .olButton {
            font-size: 2em;
            width: 1em;
            height: 1em;
            display: block;
            margin: 5px;
            text-align: center;

            border-radius: 5px;
            background: rgba(255,255,255,0.5);
        }


    </style>

</head>
<body>
<div data-role="page" id="mappage" class="page">

    <div class="header" data-role="header">
        <h2>Header</h2>
    </div>
    
    <div data-role="content" class="content">
        <div id="basicmap"></div>
    </div>

</div>
</body>

<script>
$(document).ready(function() {
    getEvents(draw_map)
});

function getEvents(callback) {
    $("#eventlist").append("<div id='loading'><img src='{{ STATIC_URL }}img/ajax-loader.gif' /></div>");
    $.ajax({
            url: "/api/events/",
            type: "GET",
            dataType: "json",
            success: function(data) {
                    if(!data.events) {
                            console.log("Error, no events in data", data)
                            return;
                    }
                    callback(data.events);
    }, error: function(jqXHR, textStatus, errorThrown) {
            console.log(jqXHR, textStatus, errorThrown);
    }
    });
}


function draw_map(events) {

    map = new OpenLayers.Map({
        div: "basicmap",
        theme: null,
        controls: [
            new OpenLayers.Control.Attribution(),
            new OpenLayers.Control.TouchNavigation({
                dragPanOptions: {
                    enableKinetic: true
                }
            }),
            new OpenLayers.Control.Zoom()
        ],
        layers: [
            new OpenLayers.Layer.OSM("OpenStreetMap", null, {
                transitionEffect: 'resize'
            })
        ], // Center to Otaniemi
        center: get_lonlat(24.822759,60.187109),
        zoom: 14
    });
    map.addLayer(get_event_layer(events));

}


function get_lonlat(lon, lat) {
    return new OpenLayers.LonLat(lon, lat) // Center of the map
            .transform(
                new OpenLayers.Projection("EPSG:4326"), // transform from WGS 1984
                new OpenLayers.Projection("EPSG:900913") // to Spherical Mercator Projection
            );
}

function get_event_vector(event) {
    var v = new OpenLayers.Feature.Vector(
                new OpenLayers.Geometry.Point(event.lon, event.lat),
                {},
                {
                    graphicName: "circle",
                    strokeColor: "red",
                    strokeWidth: 10,
                    fillOpacity: 100,
                    pointRadius: 100
                }
            );

    return v;
}

function get_event_layer(events) {    
    var layer = new OpenLayers.Layer.Vector("Vector Layer");
    
    vectors = [];
    for(var i = 0; i < events.length; i++) {
        var event = events[i];
        if(event.lat == "0" || event.lon == "0") {
            console.log("Skipping event");
            continue;
        }

        vector = get_event_vector(event);
        
        vectors.push(vector);
    }
    layer.addFeatures(vectors);

    return layer;
}    
</script>


</html>