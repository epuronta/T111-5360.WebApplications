<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    
    <!-- viewport -->
    <meta name="viewport" content="width=device-width">
    
    <!-- iOS stuff -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="white">
    
    <!-- Mobile IE allows us to activate ClearType technology for smoothing fonts for easy reading -->
    <meta http-equiv="cleartype" content="on">
    
    <!-- For mobile browsers that do not recognize the viewport tag -->
    <meta name="MobileOptimized" content="320" />
    
    <title>AaltoMobile > Events</title>
    <link rel="stylesheet" href="{{ STATIC_URL }}css/style.css" type="text/css" />
    <link rel="stylesheet" href="{{ STATIC_URL }}events/css/events.css" type="text/css" />
	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.1.0-rc.1/jquery.mobile-1.1.0-rc.1.min.css" />
    <link rel="stylesheet" type="text/css" href="http://dev.jtsage.com/cdn/simpledialog/latest/jquery.mobile.simpledialog.min.css" /> 
    
	<script src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
    <script>
		$(document).bind("mobileinit", function() {
			$.mobile.listview.prototype.options.filterPlaceholder = "Search events ...";
		});
	</script>
	<script src="http://code.jquery.com/mobile/1.1.0-rc.1/jquery.mobile-1.1.0-rc.1.min.js"></script>
    <script type="text/javascript" src="http://dev.jtsage.com/cdn/simpledialog/latest/jquery.mobile.simpledialog2.min.js"></script>
</head>
<body>
	<div id="events" data-role="page" data-theme="b">
        <header data-role="header">
            <h1>Events</h1>
            <a href="{% url launcher-index-view %}" data-role="button" data-icon="home" data-iconpos="notext">Home</a>
        </header>
        
        <div data-role="content" id="list">
            <ul id="eventlist" data-role="listview" data-filter="true" data-theme="b" data-divider-theme="b">
            </ul>
        </div>
        
    </div>
</body>

<script>

$(document).ready(function(){
	var weekday=new Array(7);
	weekday[0]="Sunday";
	weekday[1]="Monday";
	weekday[2]="Tuesday";
	weekday[3]="Wednesday";
	weekday[4]="Thursday";
	weekday[5]="Friday";
	weekday[6]="Saturday";
	
	var month=new Array(12);
	month[0]="January";
	month[1]="February";
	month[2]="March";
	month[3]="April";
	month[4]="May";
	month[5]="June";
	month[6]="July";
	month[7]="August";
	month[8]="September";
	month[9]="October";
	month[10]="November";
	month[11]="December";
	
    /*$("body").append(
		$("<div />", {"id": "loadingIndicator"}).text("Loading")
    );*/

    $.ajax({
		url: "/api/events/?limit=10&offset=0",
		type: "GET",
		dataType: "json",
		success: function(data) {
			if(!data.events) {
				console.log("Error, no events in data", data)
				return;
			}
			
			data.events.sort(compareDates);
			for(index in data.events) {
				event = data.events[index];
				//console.log(event);
				if(index == 0 || compareDates(event, data.events[index-1])) {
					var count = countSameDates(event, data.events);
					var divider = $("<li />");
					var date = createDate(event.start_date);
					divider.addClass("ui-li-divider").attr({"data-role":"list-divider","role":"heading"}).text(weekday[date.getDay()] + " " + date.getDate() + "." + month[date.getMonth()]);
					divider.append(
						$("<span />").addClass("ui-li-count").text(count)
					);
					$("#list").children("ul").append(divider);
				}
				var container = $("<li />");
				container.append($("<a />")
					.attr({"href":"#","id":"eventdialog","data-role":"button"})
					.text(event.title.substr(12))
				);
				var icon = "false"
				if(event.remote_source_name == "AaltoEvents")
					icon = "evt-icon-aalto"
				for(prop in event) {
				   	container
						.append(
							$("<span />")
								.addClass(prop)
								.addClass("property")
								.addClass("hidden")
								.text(event[prop])
							)
						.attr({"data-theme":"c","data-icon":icon,"data-iconpos":"left"});
				}
				$("#list").children("ul").append(container);
				
			}
		$('#eventlist').listview('refresh');
	}, error: function(jqXHR, textStatus, errorThrown) {
	   	console.log(jqXHR, textStatus, errorThrown);
	}
    });
	
	function countSameDates(event, events) {
		var count = 0;		
		for(index in events) {
			if(!compareDates(event, events[index]))
				count++;
		}
		return count;
	}
	
	function compareDates(evt1, evt2) {
		d1 = createDate(evt1.start_date);
		d2 = createDate(evt2.start_date);
		return d1.getTime()-d2.getTime();
	}
	
	function createDate(str) {
		regex = /(\d{4})-(\d\d)-(\d\d) (\d\d):(\d\d):(\d\d)/;
		date = regex.exec(str)
		return new Date(parseInt(date[1],10), parseInt(date[2],10)-1, parseInt(date[3],10), parseInt(date[4],10), parseInt(date[5],10), parseInt(date[6],10), 0);
	}
	
	$("#eventdialog").live("click", function() {
		var data = $(this).siblings("span");
		var title = data[5];
		var descr = data[4];
		descr = $(descr).text();
		console.log(descr)
		$('<div>').simpledialog2({
			mode: 'blank',
			headerText: $(title).text().substr(0,10),
			headerClose: true,
			blankContent : descr +
			  "<a rel='close' data-role='button' href='#'>Close</a>"
		});
	});
});

</script>
</html>